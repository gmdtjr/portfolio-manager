"""
ì¢…ëª© ìƒì„¸ ë¶„ì„ê¸° ëª¨ë“ˆ
ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì¢…ëª©ëª…ì„ ë°›ì•„ DB ì •ë³´ ìœ ë¬´ì— ë”°ë¼ ë§ì¶¤í˜• ë˜ëŠ” ì¼ë°˜ì ì¸ ì‹¬ì¸µ ë¶„ì„ìš© Deep Research í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
"""

import os
import json
import pandas as pd
from datetime import datetime
from google.oauth2 import service_account
from googleapiclient.discovery import build


class StockAnalyzerGenerator:
    """ì¢…ëª© ìƒì„¸ ë¶„ì„ í”„ë¡¬í”„íŠ¸ ìƒì„±ê¸° (íˆ¬ì ë…¸íŠ¸ ì—°ë™)"""
    
    def __init__(self, spreadsheet_id: str = None):
        """
        ì´ˆê¸°í™”
        
        Args:
            spreadsheet_id (str): Google Spreadsheet ID
        """
        self.spreadsheet_id = spreadsheet_id
        self.sheets_service = None
        
        if spreadsheet_id:
            self._setup_google_sheets()
    
    def _setup_google_sheets(self):
        """Google Sheets API ì„¤ì •"""
        try:
            # í™˜ê²½ë³€ìˆ˜ì—ì„œ ì„œë¹„ìŠ¤ ê³„ì • ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            service_account_json_str = os.getenv('GOOGLE_APPLICATION_CREDENTIALS_JSON')
            if not service_account_json_str:
                print("âš ï¸ GOOGLE_APPLICATION_CREDENTIALS_JSON í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
                return
            
            service_account_info = json.loads(service_account_json_str)
            credentials = service_account.Credentials.from_service_account_info(
                service_account_info,
                scopes=['https://www.googleapis.com/auth/spreadsheets.readonly']
            )
            self.sheets_service = build('sheets', 'v4', credentials=credentials)
            print("âœ… Google Sheets API ì„¤ì • ì™„ë£Œ")
            
        except Exception as e:
            print(f"âŒ Google Sheets API ì„¤ì • ì‹¤íŒ¨: {e}")
            self.sheets_service = None
    
    def get_investment_notes(self) -> pd.DataFrame:
        """íˆ¬ì ë…¸íŠ¸ ì‹œíŠ¸ì—ì„œ ë°ì´í„°ë¥¼ ì½ì–´ DataFrameìœ¼ë¡œ ë°˜í™˜"""
        if not self.sheets_service or not self.spreadsheet_id:
            print("âš ï¸ Google Sheets ì„œë¹„ìŠ¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
            return pd.DataFrame()
        
        try:
            result = self.sheets_service.spreadsheets().values().get(
                spreadsheetId=self.spreadsheet_id, 
                range="íˆ¬ì_ë…¸íŠ¸"
            ).execute()
            values = result.get('values', [])
            
            if not values or len(values) < 2:
                print("âš ï¸ íˆ¬ì_ë…¸íŠ¸ ì‹œíŠ¸ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
                return pd.DataFrame()
            
            df = pd.DataFrame(values[1:], columns=values[0])
            print(f"âœ… íˆ¬ì_ë…¸íŠ¸ DB ë¡œë“œ ì™„ë£Œ: {len(df)}ê°œ ì¢…ëª©")
            return df
            
        except Exception as e:
            print(f"âš ï¸ íˆ¬ì_ë…¸íŠ¸ ì‹œíŠ¸ ì½ê¸° ì‹¤íŒ¨: {e}")
            return pd.DataFrame()
    
    def find_stock_note(self, stock_name: str) -> pd.Series:
        """
        íˆ¬ì ë…¸íŠ¸ì—ì„œ í•´ë‹¹ ì¢…ëª©ì˜ ì •ë³´ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
        
        Args:
            stock_name (str): ê²€ìƒ‰í•  ì¢…ëª©ëª… ë˜ëŠ” ì½”ë“œ
            
        Returns:
            pd.Series: í•´ë‹¹ ì¢…ëª©ì˜ íˆ¬ì ë…¸íŠ¸ ì •ë³´ (ì—†ìœ¼ë©´ ë¹ˆ Series)
        """
        notes_df = self.get_investment_notes()
        
        if notes_df.empty:
            return pd.Series(dtype=object)
        
        # ì¢…ëª©ëª… ë˜ëŠ” ì¢…ëª©ì½”ë“œë¡œ ê²€ìƒ‰
        mask = (
            notes_df['ì¢…ëª©ëª…'].str.contains(stock_name, case=False, na=False) |
            (notes_df['ì¢…ëª©ì½”ë“œ'] == stock_name)
        )
        
        if mask.any():
            return notes_df[mask].iloc[0]
        
        return pd.Series(dtype=object)
    
    def generate_contextual_deep_dive_prompt(self, stock_name: str, stock_note: pd.Series) -> str:
        """
        (íˆ¬ì ë…¸íŠ¸ê°€ ìˆì„ ë•Œ) ì‚¬ìš©ìì˜ ê¸°ì¡´ ë…¸íŠ¸ë¥¼ ê¸°ì¤€ìœ¼ë¡œ 'Bull vs. Bear' ê´€ì ì˜ ê· í˜• ì¡íŒ ê²€ì¦ í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
        """
        thesis = stock_note.get('íˆ¬ì ì•„ì´ë””ì–´ (Thesis)', 'ë‚´ìš© ì—†ìŒ')
        catalysts = stock_note.get('í•µì‹¬ ì´‰ë§¤ (Catalysts)', 'ë‚´ìš© ì—†ìŒ')
        risks = stock_note.get('í•µì‹¬ ë¦¬ìŠ¤í¬ (Risks)', 'ë‚´ìš© ì—†ìŒ')
        conviction = stock_note.get('íˆ¬ì í™•ì‹ ë„ (Conviction)', 'ë‚´ìš© ì—†ìŒ')
        sector = stock_note.get('ì„¹í„°/ì‚°ì—… (Sector/Industry)', 'ë‚´ìš© ì—†ìŒ')
        today = datetime.now().strftime('%Yë…„ %mì›” %dì¼')

        return f"""# {stock_name} ê· í˜• ë¶„ì„ ë° íˆ¬ì ë…¸íŠ¸ ê²€ì¦ ë³´ê³ ì„œ ({today})

## [ì¤‘ìš” ì§€ì‹œì‚¬í•­]
- **ì—­í•  ë¶€ì—¬:** ë‹¹ì‹ ì€ ë‚˜ì˜ ìµœì¢… ì˜ì‚¬ê²°ì •ì„ ë•ê¸° ìœ„í•´, **ê°ê´€ì ì¸ ë°ì´í„°ì— ê¸°ë°˜í•œ ì°¬ì„±ë¡ (Bull Case)ê³¼ ë°˜ëŒ€ë¡ (Bear Case)ì„ ëª¨ë‘ ì œì‹œí•˜ëŠ” 'ê· í˜• ë¶„ì„ê°€'**ì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ì„ë¬´ëŠ” ê²°ë¡ ì„ ë‚´ë¦¬ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ë‚´ê°€ ìµœìƒì˜ ê²°ì •ì„ ë‚´ë¦´ ìˆ˜ ìˆë„ë¡ ì–‘ì§ˆì˜ ì¬ë£Œ(ì–‘ë©´ì  ë¶„ì„)ë¥¼ ì œê³µí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
- **ì–¸ì–´:** ëª¨ë“  ê²°ê³¼ë¬¼ì€ ë°˜ë“œì‹œ **í•œê¸€**ë¡œë§Œ ì‘ì„±í•´ì£¼ì„¸ìš”.

## ë¶„ì„ ëª©í‘œ:
ì•„ë˜ ì œì‹œëœ **[ë‚˜ì˜ ê¸°ì¡´ íˆ¬ì ë…¸íŠ¸]**ë¥¼ ê¸°ì¤€ìœ¼ë¡œ, ìµœì‹  ì •ë³´ë¥¼ í™œìš©í•˜ì—¬ {stock_name}ì— ëŒ€í•œ **ê· í˜• ì¡íŒ ì°¬ë°˜ ë¶„ì„**ì„ ìˆ˜í–‰í•˜ê³ , ë‚˜ì˜ ê¸°ì¡´ íˆ¬ì ì•„ì´ë””ì–´ì˜ ê°•ì ê³¼ ì•½ì ì„ ê°ê´€ì ìœ¼ë¡œ í‰ê°€í•˜ì‹œì˜¤.

## [ë‚˜ì˜ ê¸°ì¡´ íˆ¬ì ë…¸íŠ¸]
- ë‚˜ì˜ íˆ¬ì ì•„ì´ë””ì–´: {thesis}
- ë‚´ê°€ ê¸°ëŒ€í•˜ëŠ” í•µì‹¬ ì´‰ë§¤: {catalysts}
- ë‚´ê°€ ìš°ë ¤í•˜ëŠ” í•µì‹¬ ë¦¬ìŠ¤í¬: {risks}

---
## ë¶„ì„ ëª©ì°¨:
*ì•„ë˜ ëª©ì°¨ì— ë”°ë¼, ëª¨ë“  í•­ëª©ì— ëŒ€í•´ **ì°¬ì„±ë¡ ê³¼ ë°˜ëŒ€ë¡ ì„ í•¨ê»˜ ì œì‹œ**í•´ì£¼ì‹­ì‹œì˜¤.*

**1. íˆ¬ì ì•„ì´ë””ì–´ (Investment Thesis):**
   - **ì°¬ì„±ë¡  (Bull Case):** ë‚˜ì˜ íˆ¬ì ì•„ì´ë””ì–´ë¥¼ ë’·ë°›ì¹¨í•˜ëŠ” ê°€ì¥ ê°•ë ¥í•œ ìµœì‹  ë°ì´í„°ë‚˜ ê·¼ê±°ëŠ” ë¬´ì—‡ì¸ê°€?
   - **ë°˜ëŒ€ë¡  (Bear Case):** ë‚˜ì˜ íˆ¬ì ì•„ì´ë””ì–´ë¥¼ ë°˜ë°•í•  ìˆ˜ ìˆëŠ” ê°€ì¥ ê°•ë ¥í•œ ë…¼ë¦¬ë‚˜ ë°ì´í„°ëŠ” ë¬´ì—‡ì¸ê°€?

**2. ê²½ì œì  í•´ì (Economic Moat):**
   - **ì°¬ì„±ë¡  (Bull Case):** ë‚˜ì˜ ë…¸íŠ¸ì— ê¸°ë¡ëœ í•´ì ê´€ì ì„ ë’·ë°›ì¹¨í•˜ëŠ” ê°€ì¥ ê°•ë ¥í•œ ì¦ê±°ëŠ” ë¬´ì—‡ì¸ê°€?
   - **ë°˜ëŒ€ë¡  (Bear Case):** ë‚˜ì˜ í•´ì ê°€ì„¤ì´ ê³¼ëŒ€í‰ê°€ë˜ì—ˆê±°ë‚˜ ë¯¸ë˜ì— í›¼ì†ë  ìˆ˜ ìˆëŠ” ê°€ì¥ í° ì´ìœ ëŠ” ë¬´ì—‡ì¸ê°€?

**3. ì„±ì¥ ë™ë ¥ ë° ì´‰ë§¤ (Growth Drivers & Catalysts):**
   - **ì°¬ì„±ë¡  (Bull Case):** ë‚´ê°€ ê¸°ëŒ€í•˜ëŠ” 'ì´‰ë§¤'ë“¤ì´ ì‹¤í˜„ë  ê¸ì •ì ì¸ ì‹ í˜¸ëŠ” ë¬´ì—‡ì¸ê°€?
   - **ë°˜ëŒ€ë¡  (Bear Case):** ì´ ì„±ì¥ ìŠ¤í† ë¦¬ê°€ ì‹¤í˜„ë˜ì§€ ì•Šì„ ìˆ˜ ìˆëŠ” ê°€ì¥ í° ì¥ì• ë¬¼(Headwind)ì€ ë¬´ì—‡ì¸ê°€?

**4. ë¦¬ìŠ¤í¬ ë¶„ì„ (Risk Analysis):**
   - ë‚´ê°€ ìš°ë ¤í•˜ëŠ” 'í•µì‹¬ ë¦¬ìŠ¤í¬' ì™¸ì—, í˜„ì¬ ì‹œì¥ì—ì„œ ìƒˆë¡­ê²Œ ë¶€ìƒí•˜ê³  ìˆëŠ” ì ì¬ì  ë¦¬ìŠ¤í¬ëŠ” ë¬´ì—‡ì¸ê°€? ê° ë¦¬ìŠ¤í¬ì˜ ë°œìƒ ê°€ëŠ¥ì„±ê³¼ ì˜ˆìƒ íŒŒê¸‰ íš¨ê³¼ë¥¼ ë¶„ì„í•˜ì‹œì˜¤.

**5. ë°¸ë¥˜ì—ì´ì…˜ (Valuation):**
   - **ì°¬ì„±ë¡  (Bull Case):** í˜„ì¬ ì£¼ê°€ê°€ ì™œ ì—¬ì „íˆ ë§¤ë ¥ì ì¸ ì§„ì…ì ì´ë¼ê³  í•  ìˆ˜ ìˆëŠ”ê°€?
   - **ë°˜ëŒ€ë¡  (Bear Case):** í˜„ì¬ ì£¼ê°€ê°€ ì™œ ì´ë¯¸ ê³ í‰ê°€ë˜ì—ˆê±°ë‚˜ 'ë°¸ë¥˜ì—ì´ì…˜ í•¨ì •'ì¼ ìˆ˜ ìˆëŠ”ê°€?

**6. ìµœì¢… ì˜ì‚¬ê²°ì •ì„ ìœ„í•œ í•µì‹¬ ì§ˆë¬¸ (Key Questions for Decision):**
   - **ì§€ì‹œì‚¬í•­:** ìœ„ ëª¨ë“  ì°¬ë°˜ ë¶„ì„ì„ ì¢…í•©í•˜ì—¬, ë‚´ê°€ ìµœì¢…ì ìœ¼ë¡œ íˆ¬ìë¥¼ 'ê²°ì •'í•˜ê¸° ìœ„í•´ ìŠ¤ìŠ¤ë¡œì—ê²Œ ë˜ì ¸ì•¼ í•  ê°€ì¥ ì¤‘ìš”í•œ ì§ˆë¬¸ 3ê°€ì§€ë¥¼ ì œì‹œí•´ì£¼ì‹œì˜¤.
   - (ì˜ˆì‹œ) "ë‹¨ê¸°ì ì¸ ë°¸ë¥˜ì—ì´ì…˜ ë¶€ë‹´ì—ë„ ë¶ˆêµ¬í•˜ê³ , ì¥ê¸°ì ì¸ ê¸°ìˆ ì  í•´ìë¥¼ ë” ë†’ê²Œ í‰ê°€í•  ê²ƒì¸ê°€?"

**7. íˆ¬ì ë…¸íŠ¸ DB ë™ê¸°í™”ë¥¼ ìœ„í•œ ìš”ì•½ (For DB Sync):**
   - **íˆ¬ì ì•„ì´ë””ì–´:** [ê°€ì¥ í•µì‹¬ì ì¸ ì°¬ì„± ë…¼ë¦¬ ìš”ì•½]
   - **í•µì‹¬ ì´‰ë§¤:** [ê°€ì¥ ì¤‘ìš”í•œ ê¸ì •ì  ì´ë²¤íŠ¸ 3ê°€ì§€]
   - **í•µì‹¬ ë¦¬ìŠ¤í¬:** [ê°€ì¥ ì¤‘ìš”í•œ ë¶€ì •ì  ìœ„í—˜ ìš”ì¸ 3ê°€ì§€]
   - **í•µì‹¬ ëª¨ë‹ˆí„°ë§ ì§€í‘œ:** [ì°¬ì„±/ë°˜ëŒ€ ë…¼ë¦¬ ì¤‘ ì–´ëŠ ìª½ì´ í˜„ì‹¤í™”ë˜ëŠ”ì§€ íŒë‹¨í•  ìˆ˜ ìˆëŠ” í•µì‹¬ ì§€í‘œ 3ê°€ì§€]
"""

    def generate_generic_deep_dive_prompt(self, stock_name: str) -> str:
        """
        (íˆ¬ì ë…¸íŠ¸ì— ì •ë³´ê°€ ì—†ì„ ë•Œ) 'Bull vs. Bear' ê´€ì ì˜ ê· í˜• ì¡íŒ ë¶„ì„ í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
        """
        today = datetime.now().strftime('%Yë…„ %mì›” %dì¼')

        return f"""# {stock_name} ê· í˜• ë¶„ì„ ë³´ê³ ì„œ (Bull vs. Bear) ({today})

## [ì¤‘ìš” ì§€ì‹œì‚¬í•­]
- **ì—­í•  ë¶€ì—¬:** ë‹¹ì‹ ì€ íŠ¹ì • ì¢…ëª©ì— ëŒ€í•´ **ë‚™ê´€ë¡ (Bull Case)ê³¼ ë¹„ê´€ë¡ (Bear Case)ì„ ëª¨ë‘ ì œì‹œ**í•˜ëŠ” ê°ê´€ì ì´ê³  ê· í˜• ì¡íŒ ì‹œê°ì˜ ì• ë„ë¦¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ì„ë¬´ëŠ” ê²°ë¡ ì„ ë‚´ë¦¬ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ë‚´ê°€ ìµœìƒì˜ ê²°ì •ì„ ë‚´ë¦´ ìˆ˜ ìˆë„ë¡ ì–‘ì§ˆì˜ ì¬ë£Œ(ì–‘ë©´ì  ë¶„ì„)ë¥¼ ì œê³µí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
- **ì–¸ì–´:** ëª¨ë“  ê²°ê³¼ë¬¼ì€ ë°˜ë“œì‹œ **í•œê¸€**ë¡œë§Œ ì‘ì„±í•´ì£¼ì„¸ìš”.

## ë¶„ì„ ëª©í‘œ:
{stock_name}ì— ëŒ€í•œ ì¢…í•©ì ì¸ ë¶„ì„ì„ í†µí•´, ì´ ê¸°ì—…ì— ëŒ€í•œ **ê°€ì¥ ê°•ë ¥í•œ íˆ¬ì ì°¬ì„± ë…¼ê±°(Bull Case)**ì™€ **ê°€ì¥ ê°•ë ¥í•œ íˆ¬ì ë°˜ëŒ€ ë…¼ê±°(Bear Case)**ë¥¼ ëª¨ë‘ ì œì‹œí•˜ì—¬, ë‚´ê°€ í•©ë¦¬ì ì¸ íˆ¬ì ê²°ì •ì„ ë‚´ë¦´ ìˆ˜ ìˆë„ë¡ ì§€ì›í•˜ì‹œì˜¤.

## ë¶„ì„ ëª©ì°¨:
*ì•„ë˜ ëª©ì°¨ ìˆœì„œì™€ í•­ëª©ì„ ë°˜ë“œì‹œ ì¤€ìˆ˜í•˜ì—¬, ëª¨ë“  í•­ëª©ì— ëŒ€í•´ ì°¬ì„±/ë°˜ëŒ€ ë…¼ë¦¬ë¥¼ í•¨ê»˜ ë¶„ì„í•´ì£¼ì‹­ì‹œì˜¤.*

**1. í•µì‹¬ íˆ¬ì ë…¼ìŸ (The Key Debate):**
   - í˜„ì¬ ì‹œì¥ì—ì„œ {stock_name}ì„ ë‘˜ëŸ¬ì‹¼ ê°€ì¥ í° ì˜ê²¬ ëŒ€ë¦½ì€ ë¬´ì—‡ì¸ê°€?

**2. ê²½ì œì  í•´ì (Economic Moat):**
   - **ì°¬ì„±ë¡  (Bull Case):** ì´ ê¸°ì—…ì˜ í•´ìê°€ ì™œ ê°•ë ¥í•˜ê³  ì§€ì† ê°€ëŠ¥í•œê°€?
   - **ë°˜ëŒ€ë¡  (Bear Case):** ì´ í•´ìê°€ ë³´ê¸°ë³´ë‹¤ ì•½í•˜ê±°ë‚˜ ë¯¸ë˜ì— í›¼ì†ë  ìˆ˜ ìˆëŠ” ì´ìœ ëŠ” ë¬´ì—‡ì¸ê°€?

**3. ì„±ì¥ ë™ë ¥ (Growth Drivers):**
   - **ì°¬ì„±ë¡  (Bull Case):** í–¥í›„ ì„±ì¥ì„ ì´ëŒ ëª…í™•í•˜ê³  ê°•ë ¥í•œ ì´‰ë§¤ëŠ” ë¬´ì—‡ì¸ê°€?
   - **ë°˜ëŒ€ë¡  (Bear Case):** ì´ ì„±ì¥ ìŠ¤í† ë¦¬ê°€ ì‹¤í˜„ë˜ì§€ ì•Šì„ ìˆ˜ ìˆëŠ” ê°€ì¥ í° ì¥ì• ë¬¼(Headwind)ì€ ë¬´ì—‡ì¸ê°€?

**4. ë¦¬ìŠ¤í¬ ë¶„ì„ (Risk Analysis):**
   - íˆ¬ììë“¤ì´ ê°€ì¥ ì£¼ëª©í•´ì•¼ í•  í•µì‹¬ ë¦¬ìŠ¤í¬ ìš”ì¸ë“¤ì„ ë¶„ì„í•˜ê³ , ê° ë¦¬ìŠ¤í¬ê°€ í˜„ì‹¤í™”ë  ê°€ëŠ¥ì„±ì„ í‰ê°€í•˜ì‹œì˜¤.

**5. ë°¸ë¥˜ì—ì´ì…˜ (Valuation):**
   - **ì°¬ì„±ë¡  (Bull Case):** í˜„ì¬ ì£¼ê°€ê°€ ì™œ ì—¬ì „íˆ ë§¤ë ¥ì ì¸ ì§„ì…ì ì´ë¼ê³  í•  ìˆ˜ ìˆëŠ”ê°€?
   - **ë°˜ëŒ€ë¡  (Bear Case):** í˜„ì¬ ì£¼ê°€ê°€ ì™œ ì´ë¯¸ ê³ í‰ê°€ë˜ì—ˆê±°ë‚˜ 'ë°¸ë¥˜ì—ì´ì…˜ í•¨ì •'ì¼ ìˆ˜ ìˆëŠ”ê°€?

**6. ìµœì¢… ì˜ì‚¬ê²°ì •ì„ ìœ„í•œ í•µì‹¬ ì§ˆë¬¸ (Key Questions for Decision):**
   - **ì§€ì‹œì‚¬í•­:** ìœ„ ëª¨ë“  ì°¬ë°˜ ë¶„ì„ì„ ì¢…í•©í•˜ì—¬, ë‚´ê°€ ìµœì¢…ì ìœ¼ë¡œ íˆ¬ìë¥¼ 'ê²°ì •'í•˜ê¸° ìœ„í•´ ìŠ¤ìŠ¤ë¡œì—ê²Œ ë˜ì ¸ì•¼ í•  ê°€ì¥ ì¤‘ìš”í•œ ì§ˆë¬¸ 3ê°€ì§€ë¥¼ ì œì‹œí•´ì£¼ì‹œì˜¤.

**7. íˆ¬ì ë…¸íŠ¸ DB ìƒì„±ì„ ìœ„í•œ ìš”ì•½ (For DB Sync):**
   - **ì§€ì‹œì‚¬í•­:** ìœ„ ë¶„ì„ì„ ì¢…í•©í•˜ì—¬, ë‚´ê°€ ì´ ì¢…ëª©ì— ëŒ€í•œ 'íˆ¬ì ë…¸íŠ¸'ë¥¼ ìƒˆë¡œ ì‘ì„±í•  ìˆ˜ ìˆë„ë¡ ì•„ë˜ í˜•ì‹ì— ë§ì¶° í•µì‹¬ ë‚´ìš©ì„ ìš”ì•½í•´ì£¼ì‹­ì‹œì˜¤.
   - **íˆ¬ì ì•„ì´ë””ì–´ (Thesis):** [ê°€ì¥ í•µì‹¬ì ì¸ íˆ¬ì ì°¬ì„± ë…¼ë¦¬ë¥¼ 1~2ì¤„ë¡œ ìš”ì•½]
   - **í•µì‹¬ ì´‰ë§¤ (Catalysts):** [ê°€ì¥ ì¤‘ìš”í•œ ê¸ì •ì  ì´ë²¤íŠ¸ 3ê°€ì§€]
   - **í•µì‹¬ ë¦¬ìŠ¤í¬ (Risks):** [ê°€ì¥ ì¤‘ìš”í•œ ë¶€ì •ì  ìœ„í—˜ ìš”ì¸ 3ê°€ì§€]
   - **í•µì‹¬ ëª¨ë‹ˆí„°ë§ ì§€í‘œ (KPIs):** [ì´ íˆ¬ìì˜ ì„±íŒ¨ë¥¼ ê°€ëŠ í•  ê°€ì¥ ì¤‘ìš”í•œ ë°ì´í„° ì§€í‘œ 3ê°€ì§€]
"""
    
    def generate_deep_dive_prompt(self, stock_name: str) -> tuple[str, bool]:
        """
        ì¢…ëª©ëª…ì„ ë°›ì•„ íˆ¬ì ë…¸íŠ¸ ì •ë³´ ìœ ë¬´ì— ë”°ë¼ ì ì ˆí•œ í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
        
        Args:
            stock_name (str): ë¶„ì„í•  ì¢…ëª©ëª… ë˜ëŠ” ì½”ë“œ
            
        Returns:
            tuple[str, bool]: (ìƒì„±ëœ í”„ë¡¬í”„íŠ¸, íˆ¬ì ë…¸íŠ¸ì—ì„œ ì •ë³´ë¥¼ ì°¾ì•˜ëŠ”ì§€ ì—¬ë¶€)
        """
        sanitized_stock_name = stock_name.strip()
        
        # íˆ¬ì ë…¸íŠ¸ì—ì„œ í•´ë‹¹ ì¢…ëª© ì •ë³´ ê²€ìƒ‰
        stock_note = self.find_stock_note(sanitized_stock_name)
        
        # ë…¸íŠ¸ ìœ ë¬´ì— ë”°ë¼ ë‹¤ë¥¸ í”„ë¡¬í”„íŠ¸ ìƒì„±
        if not stock_note.empty:
            final_prompt = self.generate_contextual_deep_dive_prompt(sanitized_stock_name, stock_note)
            return final_prompt, True
        else:
            final_prompt = self.generate_generic_deep_dive_prompt(sanitized_stock_name)
            return final_prompt, False


def main():
    """í…ŒìŠ¤íŠ¸ìš© ë©”ì¸ í•¨ìˆ˜"""
    print("ğŸ§ª ì¢…ëª© ìƒì„¸ ë¶„ì„ê¸° í…ŒìŠ¤íŠ¸")
    print("=" * 50)
    
    # í™˜ê²½ë³€ìˆ˜ í™•ì¸
    spreadsheet_id = os.getenv('GOOGLE_SPREADSHEET_ID')
    if not spreadsheet_id:
        print("âš ï¸ GOOGLE_SPREADSHEET_ID í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        print("ğŸ“ ì¼ë°˜ ë¶„ì„ í”„ë¡¬í”„íŠ¸ë§Œ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.")
        generator = StockAnalyzerGenerator()
    else:
        print(f"âœ… Google Spreadsheet ID: {spreadsheet_id}")
        generator = StockAnalyzerGenerator(spreadsheet_id)
    
    # í…ŒìŠ¤íŠ¸ ì¢…ëª©ë“¤
    test_stocks = ["ì—”ë¹„ë””ì•„", "ASML", "005930", "ì‚¼ì„±ì „ì"]
    
    for stock in test_stocks:
        print(f"\nğŸ“Š {stock} ë¶„ì„ í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘...")
        prompt, found_in_db = generator.generate_deep_dive_prompt(stock)
        
        if found_in_db:
            print(f"âœ… DBì—ì„œ ì •ë³´ ë°œê²¬! ë§ì¶¤í˜• ê²€ì¦ í”„ë¡¬í”„íŠ¸ ìƒì„± ì™„ë£Œ (ê¸¸ì´: {len(prompt)}ì)")
        else:
            print(f"â„¹ï¸ DBì— ì •ë³´ ì—†ìŒ. í‘œì¤€ ë¶„ì„ í”„ë¡¬í”„íŠ¸ ìƒì„± ì™„ë£Œ (ê¸¸ì´: {len(prompt)}ì)")
        
        print(f"ğŸ“ í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸°:\n{prompt[:200]}...")
    
    print("\nâœ… í…ŒìŠ¤íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")


if __name__ == "__main__":
    main()