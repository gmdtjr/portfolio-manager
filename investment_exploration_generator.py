import streamlit as st

def generate_exploration_prompt(investment_idea: str, exclusions: str = "") -> str:
    """
    ì‚¬ìš©ìì˜ íˆ¬ì ì•„ì´ë””ì–´ì™€ ì œì™¸ ì¡°ê±´ì„ ë°›ì•„,
    ê· í˜• ì¡íŒ ì‹œê°ì˜ Deep Research í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    """
    
    investment_theme = investment_idea.strip()
    
    exclusion_section = ""
    if exclusions.strip():
        exclusion_section = f"3.  **ì œì™¸ ì¡°ê±´:** {exclusions.strip()}ê³¼ ê°™ì´ íŠ¹ì •ëœ ë¶„ì•¼ëŠ” ë¶„ì„ì—ì„œ ì œì™¸í•  ê²ƒ."

    # 'ê· í˜• ë¶„ì„' ì² í•™ì´ ì ìš©ëœ ë§ˆìŠ¤í„° í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿
    master_prompt_template = f"""# ìœ ë§ ì‚°ì—… ë° ì¢…ëª© ë°œêµ´ì„ ìœ„í•œ ê· í˜• ë¶„ì„ ë³´ê³ ì„œ

## [ì¤‘ìš” ì§€ì‹œì‚¬í•­]
- **ì—­í•  ë¶€ì—¬:** ë‹¹ì‹ ì€ ë‚˜ì˜ ìµœì¢… ì˜ì‚¬ê²°ì •ì„ ë•ê¸° ìœ„í•´, **ê°ê´€ì ì¸ ë°ì´í„°ì— ê¸°ë°˜í•œ ì°¬ì„±ë¡ (Bull Case)ê³¼ ë°˜ëŒ€ë¡ (Bear Case)ì„ ëª¨ë‘ ì œì‹œí•˜ëŠ” 'ê· í˜• ë¶„ì„ê°€'**ì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ì„ë¬´ëŠ” ê²°ë¡ ì„ ë‚´ë¦¬ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ë‚´ê°€ ìµœìƒì˜ ê²°ì •ì„ ë‚´ë¦´ ìˆ˜ ìˆë„ë¡ ì–‘ì§ˆì˜ ì¬ë£Œ(ì–‘ë©´ì  ë¶„ì„)ë¥¼ ì œê³µí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
- **ì–¸ì–´:** ëª¨ë“  ê²°ê³¼ë¬¼ì€ ë°˜ë“œì‹œ **í•œê¸€**ë¡œë§Œ ì‘ì„±í•´ì£¼ì„¸ìš”.

## í•µì‹¬ íˆ¬ì í…Œë§ˆ:
{investment_theme}

## ë¶„ì„ ëª©í‘œ:
ìœ„ íˆ¬ì í…Œë§ˆì™€ ê´€ë ¨í•˜ì—¬, í–¥í›„ 5ë…„ê°„ **ê°€ì¥ ë†’ì€ 'ìœ„í—˜ ì¡°ì • ìˆ˜ìµë¥ (Risk-Adjusted Return)' ì ì¬ë ¥**ì„ ê°€ì§„ ìœ ë§ ì‚°ì—… Top 3ì™€, ê° ì‚°ì—… ë‚´ í•µì‹¬ ì¢…ëª© 1~2ê°œë¥¼ ë°œêµ´í•˜ì‹œì˜¤. ëª¨ë“  ë¶„ì„ì€ **ì°¬ì„±ë¡ ê³¼ ë°˜ëŒ€ë¡ ì„ í•¨ê»˜ ì œì‹œ**í•˜ì—¬ ë‚´ê°€ í•©ë¦¬ì ì¸ ê²°ì •ì„ ë‚´ë¦´ ìˆ˜ ìˆë„ë¡ ì§€ì›í•´ì•¼ í•©ë‹ˆë‹¤.

## ì„¸ë¶€ ë¶„ì„ ìš”ê±´:
1.  **ì‚°ì—… ë¶„ì„:** ê° ìœ ë§ ì‚°ì—…ì˜ ì‹œì¥ ê·œëª¨(TAM), ì„±ì¥ë¥ (CAGR), ì„±ì¥ ë™ë ¥(Bull Case)ì„ ë¶„ì„í•¨ê³¼ ë™ì‹œì—, **í•´ë‹¹ ì‚°ì—…ì˜ ê°€ì¥ í° ì•½ì ê³¼ íˆ¬ììë“¤ì´ ê°„ê³¼í•˜ëŠ” ì¹˜ëª…ì ì¸ ë¦¬ìŠ¤í¬(Bear Case)**ëŠ” ë¬´ì—‡ì¸ì§€ ë°˜ë“œì‹œ ë¶„ì„í•  ê²ƒ.
2.  **ì¢…ëª© ë¶„ì„:** ê° í•µì‹¬ ì¢…ëª©ì˜ ë¹„ì¦ˆë‹ˆìŠ¤ ëª¨ë¸, ê¸°ìˆ ì  í•´ì(Bull Case)ë¥¼ ë¶„ì„í•¨ê³¼ ë™ì‹œì—, **ê°€ì¥ ë¹„ê´€ì ì¸ ì‹œë‚˜ë¦¬ì˜¤(Worst-Case Scenario)ì™€ í˜„ì¬ ë°¸ë¥˜ì—ì´ì…˜ì˜ ê±°í’ˆ ê°€ëŠ¥ì„±(Bear Case)**ë„ í•¨ê»˜ ë¶„ì„í•  ê²ƒ.
{exclusion_section}

---
## ê²°ê³¼ë¬¼ í˜•ì‹:
*ê° ì‚°ì—…/ì¢…ëª©ì— ëŒ€í•´ ì•„ë˜ ë‚´ìš©ì„ ë°˜ë“œì‹œ í¬í•¨í•˜ì—¬ ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì£¼ì‹­ì‹œì˜¤.*

### **[ì‚°ì—…ëª… 1]**
- **ì°¬ì„±ë¡  (Bull Case):** ì´ ì‚°ì—…ì´ ì™œ ë§¤ë ¥ì ì¸ê°€? (ì„±ì¥ ë™ë ¥, TAM ë“±)
- **ë°˜ëŒ€ë¡  (Bear Case):** ì´ ì‚°ì—…ì˜ ê°€ì¥ í° ë¦¬ìŠ¤í¬ì™€ ì•½ì ì€ ë¬´ì—‡ì¸ê°€?

#### **- í•µì‹¬ ë°œêµ´ ì¢…ëª© 1: [ì¢…ëª©ëª…]**
  - **ì°¬ì„±ë¡  (Pros):** ì´ ì¢…ëª©ì´ ê°€ì§„ ê°•ì ê³¼ ê¸°íšŒ ìš”ì¸.
  - **ë°˜ëŒ€ë¡  (Cons):** ì´ ì¢…ëª©ì˜ ì•½ì ê³¼ ì ì¬ì  ë¦¬ìŠ¤í¬.

### **[ì‚°ì—…ëª… 2]**
... (ìœ„ì™€ ë™ì¼í•œ í˜•ì‹ìœ¼ë¡œ ë°˜ë³µ) ...

---
### **ìµœì¢… ì˜ì‚¬ê²°ì •ì„ ìœ„í•œ í•µì‹¬ ì§ˆë¬¸ (Key Questions for Decision):**
- **ì§€ì‹œì‚¬í•­:** ìœ„ ëª¨ë“  ë¶„ì„ì„ ì¢…í•©í•˜ì—¬, ë‚´ê°€ ì´ ì‚°ì—…/ì¢…ëª©ë“¤ì— ëŒ€í•œ ìµœì¢… íˆ¬ìë¥¼ 'ê²°ì •'í•˜ê¸° ìœ„í•´ ìŠ¤ìŠ¤ë¡œì—ê²Œ ë˜ì ¸ì•¼ í•  ê°€ì¥ ì¤‘ìš”í•œ ì§ˆë¬¸ 3ê°€ì§€ë¥¼ ì œì‹œí•´ì£¼ì‹œì˜¤.
"""
    
    return master_prompt_template.strip()

def render_exploration_page():
    """ìœ ë§ ì¢…ëª© íƒìƒ‰ê¸° í˜ì´ì§€ ë Œë”ë§"""
    
    st.title("ğŸ§­ ìœ ë§ ì‚°ì—… ë° ì¢…ëª© íƒìƒ‰ê¸° (ê· í˜• ë¶„ì„)")
    st.markdown("ë‚˜ì˜ íˆ¬ì ì•„ì´ë””ì–´ë¥¼ ì…ë ¥í•˜ë©´, Deep Researchì— ì‚¬ìš©í•  ê· í˜• ì¡íŒ ë¶„ì„ í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•´ì¤ë‹ˆë‹¤.")

    # 1. ì‚¬ìš©ì ì…ë ¥ í•„ë“œ
    st.subheader("1. ë‚˜ì˜ íˆ¬ì ì•„ì´ë””ì–´ ì…ë ¥")
    user_idea = st.text_area(
        "label",
        placeholder="ì˜ˆì‹œ: ì €ëŠ” ì¸êµ¬ ê³ ë ¹í™”ì™€ ìë™í™” íŠ¸ë Œë“œì— ê´€ì‹¬ì´ ë§ìŠµë‹ˆë‹¤. íŠ¹íˆ, ë…¸ë™ë ¥ ë¶€ì¡± ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆëŠ” ë¡œë´‡ ê¸°ìˆ ì´ë‚˜, ë…¸ë…„ì¸µì˜ ì‚¶ì˜ ì§ˆì„ ë†’ì—¬ì£¼ëŠ” í—¬ìŠ¤ì¼€ì–´ ê¸°ìˆ ì— ì¥ê¸° íˆ¬ìí•˜ê³  ì‹¶ìŠµë‹ˆë‹¤.",
        height=150,
        label_visibility="collapsed"
    )

    user_exclusions = st.text_input(
        "ì„ íƒ: ì œì™¸í•  ì‚°ì—…/ì¢…ëª©ì´ ìˆë‹¤ë©´ ì…ë ¥í•˜ì„¸ìš”.",
        placeholder="ì˜ˆì‹œ: ë³€ë™ì„±ì´ í° ë°”ì´ì˜¤ ì‹ ì•½ ê°œë°œ ê¸°ì—…"
    )

    # 2. í”„ë¡¬í”„íŠ¸ ìƒì„± ë²„íŠ¼ ë° ê²°ê³¼ ì¶œë ¥
    st.subheader("2. Deep Research í”„ë¡¬í”„íŠ¸ ìƒì„±")

    if st.button("ğŸ¤– ê· í˜• ë¶„ì„ í”„ë¡¬í”„íŠ¸ ìƒì„±í•˜ê¸°", type="primary"):
        if not user_idea.strip():
            st.warning("íˆ¬ì ì•„ì´ë””ì–´ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.")
        else:
            # í…œí”Œë¦¿ ê¸°ë°˜ìœ¼ë¡œ í”„ë¡¬í”„íŠ¸ ì¦‰ì‹œ ìƒì„±
            final_prompt = generate_exploration_prompt(user_idea, user_exclusions)
            
            # Gemini ìë™í™”ë¥¼ ìœ„í•œ í”„ë¡¬í”„íŠ¸ ì €ì¥
            from datetime import datetime
            saved_prompt = {
                "title": f"ìœ ë§ ì¢…ëª© íƒìƒ‰ - {user_idea[:30]}{'...' if len(user_idea) > 30 else ''}",
                "content": final_prompt,
                "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                "source": "exploration",
                "investment_idea": user_idea.strip(),
                "exclusions": user_exclusions.strip()
            }
            
            if 'generated_prompts' not in st.session_state:
                st.session_state.generated_prompts = []
            
            st.session_state.generated_prompts.append(saved_prompt)
            
            st.markdown("""
            <div style="background-color: #d4edda; padding: 1rem; border-radius: 8px; border-left: 4px solid #28a745; margin-bottom: 1rem;">
                <h4 style="color: #155724; margin: 0;">âœ… ìœ ë§ ì¢…ëª© íƒìƒ‰ í”„ë¡¬í”„íŠ¸</h4>
                <p style="color: #155724; margin: 0.5rem 0 0 0; font-size: 0.9rem;">ê· í˜• ì¡íŒ ì‹œê°ì˜ ì‚°ì—… ë° ì¢…ëª© ë°œêµ´ í”„ë¡¬í”„íŠ¸ì…ë‹ˆë‹¤</p>
            </div>
            """, unsafe_allow_html=True)
            
            st.info("ğŸ’¡ ì•„ë˜ í”„ë¡¬í”„íŠ¸ë¥¼ ë³µì‚¬í•˜ì—¬ Deep Researchì— ì‚¬ìš©í•˜ê±°ë‚˜, Gemini ì›¹ ìë™í™” í˜ì´ì§€ì—ì„œ ì§ì ‘ ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
            
            # í”„ë¡¬í”„íŠ¸ í‘œì‹œ
            st.code(
                final_prompt,
                language="text",
                line_numbers=False
            )
            
            # ë³µì‚¬ ì•ˆë‚´
            st.markdown("""
            <div style="background-color: #fff3cd; padding: 1rem; border-radius: 8px; border-left: 4px solid #ffc107; margin: 1rem 0;">
                <h5 style="color: #856404; margin: 0;">ğŸ“‹ ë³µì‚¬ ë°©ë²•</h5>
                <ol style="color: #856404; margin: 0.5rem 0 0 0; padding-left: 1.5rem;">
                    <li>ìœ„ í”„ë¡¬í”„íŠ¸ ë°•ìŠ¤ë¥¼ í´ë¦­í•˜ì—¬ ì „ì²´ ì„ íƒ (Ctrl+A ë˜ëŠ” Cmd+A)</li>
                    <li>ë³µì‚¬ (Ctrl+C ë˜ëŠ” Cmd+C)</li>
                    <li>Deep Researchì— ë¶™ì—¬ë„£ê¸° (Ctrl+V ë˜ëŠ” Cmd+V)</li>
                </ol>
            </div>
            """, unsafe_allow_html=True)