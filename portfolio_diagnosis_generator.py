"""
포트폴리오 정밀 진단기 모듈
포트폴리오의 구조적 강점과 약점을 진단하고 최적화 방안을 제시하는 Deep Research 프롬프트를 생성합니다.
"""

from datetime import datetime


class PortfolioDiagnosisGenerator:
    """포트폴리오 정밀 진단 프롬프트 생성기"""
    
    def __init__(self):
        """초기화"""
        pass
    
    def generate_diagnosis_prompt(self) -> str:
        """
        포트폴리오 정밀 진단을 위한 최적화된
        Deep Research 프롬프트를 생성합니다.
        
        Returns:
            str: 생성된 포트폴리오 진단 프롬프트
        """
        today = datetime.now().strftime('%Y년 %m월 %d일')
        
        # 마스터 프롬프트 템플릿
        master_prompt_template = f"""# 포트폴리오 정밀 진단 및 최적화 방안 보고서 ({today})

## **[중요 지시사항]**
- **모든 결과물은 반드시 한글로만 작성해주세요.**
- 영문 용어는 필요한 경우에만 괄호 안에 병기하고(예: 경제적 해자(Economic Moat)), 그 외 모든 서술은 한글로 해야 합니다.

## **분석 목표:**
첨부된 2개의 포트폴리오 파일(`포트폴리오_현황.csv`, `투자_노트.csv`)을 종합적으로 분석하여, 현재 포트폴리오의 구조적 강점과 약점을 진단하고, 장기 수익률 개선을 위한 구체적인 최적화 방안을 제시하시오.

## **핵심 진단 항목:**
*아래 4가지 항목에 대해 깊이 있게 분석하고, 각각에 대한 평가를 내려주십시오.*

**1. 자산 배분 분석 (Asset Allocation):**
   - **주식/현금 비중:** 현재의 주식과 현금 비중은 시장의 변동성을 고려할 때 방어적인가, 공격적인가?
   - **지역별 배분:** 국내 주식과 해외 주식의 비중은 적절하게 분산되어 있는가? 특정 지역의 지정학적 리스크에 과도하게 노출되어 있지는 않은가?

**2. 섹터 집중도 분석 (Sector Concentration):**
   - **섹터 편중 리스크:** `투자_노트.csv`의 '섹터/산업' 분류를 기준으로, 특정 섹터(예: 기술주, 반도체)에 대한 편중이 심하지 않은가?
   - **소외 섹터 점검:** 현재 포트폴리오가 놓치고 있는 중요한 메가 트렌드나 유망 섹터는 없는가?

**3. 종목 간 상관관계 분석 (Correlation Analysis):**
   - **분산 효과 점검:** 포트폴리오 내 상위 5개 종목들의 과거 주가 움직임을 분석했을 때, 이들이 너무 유사하게 움직여 시장 하락 시 분산 효과를 제대로 제공하지 못할 위험은 없는가?

**4. '투자 노트'와 실제 포트폴리오의 괴리 분석 (Conviction vs. Weighting):**
   - **신념과 비중의 불일치:** `투자_노트.csv`와 `포트폴리오_현황.csv`를 비교하여, 나의 투자 아이디어나 확신도와 실제 포트폴리오 비중 사이에 모순점은 없는가?
     - (예시 1) 투자 확신도는 '하(Low)'인데 비중이 여전히 높은 종목은 없는가? (리스크 관리 실패)
     - (예시 2) 투자 확신도는 '상(High)'인데 비중이 너무 낮아 기회비용을 놓치고 있는 종목은 없는가? (과감성 부족)

## **결과물 요구사항:**

### **1. 진단 결과 (Diagnosis Report)**
- **종합 건강 점수:** 포트폴리오의 전반적인 건강 상태를 A(매우 우수), B(양호), C(개선 필요), D(위험) 등급으로 평가하고 그 이유를 요약할 것.
- **항목별 진단:** 위 '핵심 진단 항목' 4가지 각각에 대해 A/B/C/D 등급과 함께 구체적인 진단 근거를 제시할 것.

### **2. 개선 제안 (Actionable Recommendations)**
- 진단 결과를 바탕으로, 포트폴리오를 더 건강하게 만들기 위한 **구체적인 리밸런싱 전략**을 우선순위 순으로 2~3가지 제안할 것.
- (예시) "1. 기술주 편중 리스크 완화를 위해, 확신도 낮은 A종목 비중을 5% 축소하고, 소외되어 있던 B헬스케어 섹터 편입을 고려하십시오."

### **3. 모니터링 지표 (Monitoring KPIs)**
- 향후 포트폴리오 건강 상태를 지속적으로 추적하기 위해 주기적으로 점검해야 할 핵심 지표 3가지를 제시할 것.
- (예시) "1. 섹터별 비중 변화율, 2. 포트폴리오 베타 계수, 3. 최대 낙폭(MDD) 추이"
"""
        
        return master_prompt_template.strip()


def main():
    """테스트용 메인 함수"""
    print("🧪 포트폴리오 정밀 진단기 테스트")
    print("=" * 50)
    
    generator = PortfolioDiagnosisGenerator()
    
    print("📊 포트폴리오 진단 프롬프트 생성 중...")
    prompt = generator.generate_diagnosis_prompt()
    print(f"✅ 프롬프트 생성 완료 (길이: {len(prompt)}자)")
    print(f"📝 프롬프트 미리보기:\n{prompt[:300]}...")
    
    print("\n✅ 테스트가 완료되었습니다!")


if __name__ == "__main__":
    main()
